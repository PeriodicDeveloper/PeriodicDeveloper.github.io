(()=>{var t={651:t=>{function e(s){if(!(this instanceof e)||this===t.exports)return new e(s);if(!Array.isArray(s)||4!==s.length)throw new TypeError("seed must be an array with 4 numbers");this._state0U=0|s[0],this._state0L=0|s[1],this._state1U=0|s[2],this._state1L=0|s[3]}function s(){return Math.random()*Math.pow(2,32)}e.prototype.randomint=function(){var t=this._state0U,e=this._state0L,s=this._state1U,i=this._state1L,r=(i>>>0)+(e>>>0),h=s+t+(r/2>>>31)>>>0,l=r>>>0;this._state0U=s,this._state0L=i;var a=0,o=0;return a=(t^=a=t<<23|(-512&e)>>>9)^s,o=(e^=o=e<<23)^i,a^=t>>>18,o^=e>>>18|(262143&t)<<14,a^=s>>>5,o^=i>>>5|(31&s)<<27,this._state1U=a,this._state1L=o,[h,l]},e.prototype.random=function(){var t=this.randomint();return 2.3283064365386963e-10*t[0]+2220446049250313e-31*(t[1]>>>12)},t.exports=new e([s(),s(),s(),s()]),t.exports.XorShift=e},330:t=>{"use strict";t.exports={rE:"2.0.0"}}},e={};function s(i){var r=e[i];if(void 0!==r)return r.exports;var h=e[i]={exports:{}};return t[i](h,h.exports,s),h.exports}(()=>{"use strict";class t{constructor(t){this.game=t.game,this.w=t.w,this.h=t.h,this.tetrisCount=0,this.reset()}getCell(t,e){for(let s of this.cells)if(s.x==t&&s.y==e)return s;return t<this.w&&t>=0&&e<this.h&&null}addCell(t){this.cells.push(t)}solidifyCell(t){this.rows[t.y].push(t)}addTetromino(t){for(let e of t.cells)this.cells.push(e)}getclearedRows(){let t=0;for(let e in this.rows)if(this.rows[e].length==this.w){for(let t of this.rows[e])this.cells.splice(this.cells.indexOf(t),1);this.rows.splice(e,1),this.rows.unshift(new Array),this.cells.forEach((t=>{t.y<e&&(t.y+=1)})),t++}return t}reset(){this.cells=[],this.rows=[...Array(this.h)].map((()=>Array()))}}class e{constructor(t){this.w=t.w,this.h=t.h,this.game=t.game,this.rotation=0,this.controls=this.game.inputManager.listControls(),this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.frames=0,this.cellSize=Math.min(Math.floor(window.innerWidth/this.w),Math.floor(window.innerHeight/this.h)),this.canvas.width=this.w*this.cellSize,this.canvas.height=this.h*this.cellSize}drawText(t,e=null,s=null,i="16px",r="center"){null==e&&(e=this.canvas.width/2),null==s&&(s=this.canvas.height/2),this.ctx.font=`${i} Monospace`,this.ctx.textAlign=r,this.ctx.fillStyle="black",this.ctx.fillText(t,e+1,s+1),this.ctx.fillStyle="white",this.ctx.fillText(t,e,s)}drawEndScreen(t){this.clear(),this.drawText("Press space to start",null,this.canvas.height-50),t&&this.drawText("Highscores: ",null,250,"25px"),this.drawText(`Tetris JS v${this.game.version}`,null,100,"35px"),this.game.scoreboard.scores.forEach(((t,e)=>{this.drawText(`${t[0]}: ${t[1]}`,null,300+32*e)}))}drawPausedScreen(){let t=this.canvas.width/10,e=this.canvas.height/20;this.drawPlayField(),this.clear(.5),this.drawText("PAUSED",null,3*e,"32px"),this.drawText("CONTROLS:",null,5*e,"18px","center");let s=5*e;this.controls.forEach((i=>{this.drawText(`${i[0]}:`,t,s+=e,"16px","left"),this.drawText(i[1],this.canvas.width-t,s,"16px","right")}))}drawPlayField(){this.drawTetrominoGuide(this.game.currentTetromino);let t=[(this.w-1.25)*this.cellSize,0];this.drawText(`Score: ${this.game.score}`,0,16,"16px","left"),this.drawText("Next tetromino: ",t[0],16,"16px","end"),this.drawText(`Level: ${this.game.level}`,0,40,"16px","left"),this.drawCells(),this.drawTetrominoSmall(this.game.nextTetromino,t[0],0)}clear(t=1){this.ctx.beginPath(),this.ctx.fillStyle=`rgba(20, 20, 20, ${t})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.closePath()}refresh(t){this.clear(),"gameOver"==this.game.state?this.drawEndScreen(t%120>60):"paused"==this.game.state?this.drawPausedScreen():"inGame"==this.game.state&&this.drawPlayField()}drawCube(t,e,s,i,r=this.cellSize){this.ctx.beginPath(),this.ctx.fillStyle=s,this.ctx.strokeStyle=i,this.ctx.lineWidth=r/this.cellSize*4,this.ctx.fillRect(t,e,r,r),this.ctx.strokeRect(t,e,r,r)}drawCell(t){let e,s,i=[t.x*this.cellSize,t.y*this.cellSize];null!=t&&null!=t?(s="white",e=t.color):(s="black",e="black"),this.drawCube(i[0],i[1],e,s,void 0)}drawCellSmall(t,e,s){let i=t.relativePos(),r=[e+.25*i[0],s+.25*i[1]];this.drawCube(r[0],r[1],t.color,"white",this.cellSize/4)}drawCells(){this.game.playField.cells.forEach((t=>{this.drawCell(t)}))}drawTetrominoSmall(t,e,s){let i=.25*this.cellSize;for(let r of t.cells){let t=r.relativePos(),h=[e+t[0]*i,s+t[1]*i];this.drawCellSmall(r,...h)}}drawTetrominoGuide(t){let e;for(e=0;t.canMoveTo(0,e);e++);if(e--,!(e<=2))for(let s of t.cells){let t=[s.x*this.cellSize,(s.y+e)*this.cellSize];this.drawCube(t[0],t[1],"black",s.color)}}}const i={ArrowLeft:"Left Arrow",ArrowRight:"Right Arrow",ArrowUp:"Up Arrow",Space:"Space",KeyS:"S",KeyF:"F",KeyD:"D",KeyR:"R",KeyP:"P",Enter:"Enter"},r=["ArrowLeft","ArrowRight"],h={left:"Move Left (Turboable)",right:"Move Right (Turboable)",turbo:"Turbo while pressed",rotateLeft:"Rotate Left",rotateRight:"Rotate Right",drop:"Drop Tetromino",softDrop:"Soft Drop",restart:"Restart Game",pause:"Pause Game"},l={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"rotateRight",Space:"drop",KeyS:"softDrop",KeyF:"rotateRight",KeyD:"rotateLeft",KeyR:"restart",KeyP:"pause",Enter:"pause"};class a{constructor(t,e,s,i,r=!1){this.keyName=t,this.keyDesc=e,this.actionName=s,this.actionDesc=i,this.down=!1,this.activated=!1,this.canTurbo=r}getDesc(){return[this.keyDesc,this.actionDesc]}getAction(){return this.actionName}}class o{constructor(){this.keys={},this.turboKey=new a("ArrowDown","Down Arrow","turbo",h.turbo);for(let t of Object.keys(i))this.keys[t]=new a(t,i[t],l[t],h[l[t]],r.includes(t));window.addEventListener("keydown",(t=>this.handleKeys(t.code,!0))),window.addEventListener("keyup",(t=>this.handleKeys(event.code,!1)))}keyIsBinded(t){return Object.keys(this.keys).includes(t)||t==this.turboKey.keyName}handleKeys(t,e){if(!this.keyIsBinded(t))return!1;t!=this.turboKey.keyName?(e&&0==this.keys[t].down&&(this.keys[t].activated=!0),this.keys[t].down=e):this.turboKey.down=e}getPendingActions(){let t={};for(let e of Object.values(this.keys))e.activated&&(t[e.actionName]=!0),this.turboKey.down&&e.down&&e.canTurbo?e.activated=!0:e.activated=!1;return t}listControls(){let t=[];for(let e of Object.values(this.keys))t.push(e.getDesc());return t.push(this.turboKey.getDesc()),t}}class n{constructor(t){let e=window.localStorage.getItem("version");window.localStorage.setItem("version",t.version);let s=["Ryan","John","Kyle","Dom","Emma"].map(((t,e)=>[t,1e4*(e+1)])),i=JSON.parse(window.localStorage.getItem("scores"));null==i||e!=t.version?(this.scores=s,this.writeScores()):this.scores=i,this.compileScores()}addScore(t,e){this.scores.push([t,e]),this.compileScores(),this.writeScores()}writeScores(){window.localStorage.setItem("scores",JSON.stringify(this.scores))}compileScores(){this.scores=this.scores.sort(((t,e)=>e[1]-t[1])).slice(0,5)}}const c={I:[4,5,6,7],J:[0,4,5,6],L:[2,4,5,6],O:[1,2,5,6],S:[1,2,4,5],T:[1,4,5,6],Z:[0,1,5,6]},d={standard:[2,6,10,null,1,5,9,null,0,4,8],I:[3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12]};class u{constructor(t,e,s=[3,0]){this.playField=t,this.enabled=!1,this.x=s[0],this.y=s[1],this.type=e,this.prevType=null,this.rotationChart="I"==this.type?d.I:d.standard,this.color={I:"red",J:"orange",L:"yellow",O:"green",T:"blue",S:"purple",Z:"violet"}[this.type],this.pattern=c[this.type],this.cells=[],[[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15]].forEach(((t,e)=>{t.forEach(((t,s)=>{if(this.pattern.includes(t)){let i=new f(this,s+this.x,e+this.y,this.color,t);this.cells.push(i)}}))}))}addToPlayField(){this.cells.forEach((t=>this.playField.addCell(t))),this.enabled=!0}rotate(t){let e=0;if("JLSTZI".includes(this.type)){for(let s of this.cells)s.canRotate(t)&&e++;if(e==this.cells.length)for(let t of this.cells)t.setNextState()}}canMoveTo(t,e){let s=0;for(let i of this.cells)i.canMoveTo(i.x+t,i.y+e)&&s++;return s==this.cells.length}move(t,e){if(this.canMoveTo(t,e)){for(let s of this.cells)s.x+=t,s.y+=e;return this.x+=t,this.y+=e,!0}return!1}drop(){for(;this.move(0,1););}solidify(){this.cells.forEach((t=>this.playField.solidifyCell(t)))}}class f{constructor(t,e,s,i,r){this.tetromino=t,this.playField=this.tetromino.playField,this.x=e,this.y=s,this.color=i,this.address=r}relativePos(t=this.address){return[t%4,Math.floor(t/4)]}canRotate(t){let e=this.relativePos(),s=this.tetromino.rotationChart,i=s[this.address];if("left"==t)for(let t=0;t<2;t++)i=s[i];let r=this.relativePos(i),h=this.x+r[0]-e[0],l=this.y+r[1]-e[1];return this.canMoveTo(h,l,i)}canMoveTo(t,e,s=null){null==s&&(s=this.address);let i=this.playField.getCell(t,e);return null==i||this.tetromino.cells.includes(i)?(this.nextState={x:t,y:e,address:s},!0):(this.nextState=null,!1)}setNextState(){for(let[t,e]of Object.entries(this.nextState))this[t]=e;this.nextState=null}}const m=s(651).constructor;class p{constructor(t,e=null){if(null==e){e=[];for(let t=0;t<4;t++)e.push(Math.floor(Math.random()*Math.pow(2,32)))}this.playField=t,this.seed=e,this.RNG=new m(this.seed),this.tetrominos="IJLOSTZ",this.pieces=[]}refillBag(){this.pieces=this.tetrominos.split("");for(let t=this.pieces.length-1;t>0;t--){let e=Math.floor(Math.random()*t),s=this.pieces[t];this.pieces[t]=this.pieces[e],this.pieces[e]=s}}randomTetromino(){return 0===this.pieces.length&&this.refillBag(),new u(this.playField,this.pieces.pop())}}const w=s(330).rE,y=new URL(document.location).searchParams,g=Object.entries({w:{fullName:"width",type:"int",default:10},h:{fullName:"height",type:"int",default:20},lvl:{fullName:"startLevel",type:"int",default:0},pbid:{fullName:"playbackID",type:"str",default:null},dm:{fullName:"darkMode",type:"bool",default:!1},reset:{fullName:"resetScores",type:"bool",default:!1},music:{fullName:"enableMusic",type:"bool",default:!1},name:{fullName:"name",type:"str",default:"you"}}).reduce(((t,[e,s])=>("int"==s.type?t[s.fullName]=parseInt(y.get(e))||s.default:"bool"==s.type?t[s.fullName]=y.has(e)||s.default:"str"==s.type&&(t[s.fullName]=y.get(e)||s.default),console.log(t),t)),{});new class{constructor(s){this.actions={inGame:{restart:()=>this.reset(),pause:()=>{this.state="paused"},left:()=>{this.dx-=1},right:()=>{this.dx+=1},down:()=>{this.dy+=1},rotateLeft:()=>{this.currentTetromino.rotate("left")},rotateRight:()=>{this.currentTetromino.rotate("right")},drop:()=>{this.dropCurrentTetromino()},softDrop:()=>{this.dropCurrentTetromino(!0)}},gameOver:{pause:()=>{this.startGame()},drop:()=>{this.startGame()}},paused:{pause:()=>{this.state="inGame"},drop:()=>{this.state="inGame"}}},this.state="gameOver",this.dx=0,this.dy=0,this.version=w,this.startLevel=s.startLevel||0;let i=10*this.startLevel+10,r=10*this.startLevel-50;this.startingLines=r<0?i:i>r?r:i,this.width=s.width,this.height=s.height,this.scoreboard=new n(this),this.inputManager=new o(this),this.displayManager=new e({game:this,w:this.width,h:this.height,seed:s.seed,playbackData:s.playbackData}),this.playField=new t({game:this,w:this.width,h:this.height}),this.bag=new p(this.playField,s.seed),this.reset(),window.requestAnimationFrame((()=>{this.refresh()}))}reset(){this.framesUntilTick=60,this.frames=0,this.state="gameOver",this.score=0,this.level=this.startLevel,this.lines=0}startGame(){this.state="inGame",this.playField.reset(),this.getNextTetromino(),this.currentTetromino.addToPlayField(),this.changeFPT()}getNextTetromino(){this.currentTetromino=this.nextTetromino||this.bag.randomTetromino(),this.nextTetromino=this.bag.randomTetromino()}dropCurrentTetromino(t=!1){this.currentTetromino.drop(),this.framesUntilTick=t?this.framesPerTick:0}changeLevel(){this.level<=this.startLevel?this.lines>this.startingLines&&this.level++:this.level=this.startLevel+Math.ceil((this.lines-this.startingLines)/10)}changeFPT(){let t=48-Math.floor(32*Math.log10(this.level+1));return t<1&&(t=1),t!=this.framesPerTick&&(this.framesPerTick=t)}handleFullRows(){let t=this.playField.getclearedRows();4==t?(this.consecutiveTetris++,this.score+=this.consecutiveTetris>1?1200:800):(this.score+=100*t,this.consecutiveTetris=0),this.changeLevel(),this.changeFPT()}handleInput(){let t=this.inputManager.getPendingActions(),e=this.actions[this.state];for(let s of Object.keys(e))1==t[s]&&e[s]();"inGame"==this.state&&(this.currentTetromino.move(this.dx,this.dy),this.dx=0,this.dy=0)}refresh(){this.handleInput(),0==this.framesUntilTick&&(this.changeFPT(),"inGame"==this.state&&this.tick(),this.framesUntilTick=this.framesPerTick),this.displayManager.refresh(this.frames),this.framesUntilTick--,this.frames++,window.requestAnimationFrame(this.refresh.bind(this))}tick(){this.currentTetromino.move(0,1)||(this.currentTetromino.solidify(),0==this.currentTetromino.y&&(this.scoreboard.addScore("You",this.score),this.scoreboard.compileScores(),this.reset()),this.getNextTetromino(),this.currentTetromino.addToPlayField(),this.handleFullRows())}}(g)})()})();